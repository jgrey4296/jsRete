<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: ReteActionAssert.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: ReteActionAssert.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
   Defines the Assert Action
   @module ReteActionAssert
   @requires ReteArithmeticActions
   @requires ReteUtilities
   @requires ReteDataStructures
   @requires underscore
*/

var ArithmeticActions = require('./ReteArithmeticActions'),
    _ = require('underscore'),
    ReteUtil = require('./ReteUtilities'),
    RDS = require('./ReteDataStructures');


/**
   @implements {module:ReteActionInterface}
   @class AssertAction
 */
var AssertAction = {
    "name" : "assert",
    propose : null,
    perform : null
};

/**
   Propose the Assertion
   @param {module:ReteDataStructures.Token} token The token that is emitted by the network
   @param {module:ReteClassInterface.ReteNet} reteNet The top level reteNet
   @function
 */
AssertAction.propose = function(token,reteNet){
    "use strict";
    //create the data object:
    //initialise from the action's 'values' object
    var newWMEData = _.reduce(_.keys(this.values),function(memo,key){
        var v = this.values[key];
        //if the value starts with # or $, look it up in the token list
        memo[key] = v.match(/^[\$#]/) === null ? v : token.bindings[v.slice(1)];
        return memo;
    },{bindings: {} },this);

    //Then copy in the bindings:
    var newDataPlusBindings = _.reduce(_.keys(token.bindings),function(memo,key){
        memo.bindings[key] = token.bindings[key];            
        return memo;
    },newWMEData);
    
    //perform arithmetic:
    _.keys(this.arithmeticActions).forEach(function(key){
        var newVal = Number(newDataPlusBindings[key]);
        if(isNaN(newVal)) { throw new Error("Arithmetic value should be convertable to a number"); }
        //look up the function:
        //because the representation form is: a : ["+", 5]
        var action = ArithmeticActions[this.arithmeticActions[key][0]];
        newDataPlusBindings[key] = action(newVal,Number(this.arithmeticActions[key][1]));
    },this);

    //todo: allow for importing of other vars as the replacement values?
    _.keys(this.regexActions).forEach(function(key){
        var pair = this.regexActions[key],
            regex = new RegExp(pair[0],pair[1]),
            replaceValue = pair[2].match(/\$/) ? newDataPlusBindings[pair[2].slice(1)] : pair[2];
        newDataPlusBindings[key] = newDataPlusBindings[key].replace(regex,replaceValue);
    },this);
    
    //Expand out to object structure
    //ie: {values.a:5, tags.type: rule} -> {values:{a:5},tags:{type:rule}}
    var complexFormData = ReteUtil.objDescToObject(newWMEData);
    
    //DONT create the wme, just store the data for it
    //To be returned to activateActionNode
    var proposedAction = new RDS.ProposedAction(reteNet,"assert", complexFormData, token,
                                                reteNet.currentTime,
                                                this.timing,
                                                this.priority
                                                );

    return proposedAction;        
};

/**
   Perform the Assertion, after having been scheduled
   @param {module:ReteDataStructures.ProposedAction} proposedAction
   @param {module:ReteClassInterface.ReteNet} reteNet
   @function
   @return {Object}
 */
AssertAction.perform = function(proposedAction,reteNet){
    "use strict";
    //check the type matches
    if(proposedAction.actionType !== 'assert') { throw new Error("Expected Assert"); }
    //Perform the action:
    var newWMEID = reteNet.assertWME(proposedAction.payload,proposedAction.retractTime);

    //schedule the retraction:
    if(proposedAction.timing.unperformOffset > 0){
        //schedule a retract, with no invalidate time (its not being proposed)
        //and the perform time being the original actions unperformoffset
        reteNet.addToSchedule(new RDS.ProposedAction(reteNet,"retract",newWMEID,null,reteNet.currentTime,{
            invalidateOffset : null,
            performOffset : proposedAction.timing.unperformOffset,
            unperformOffset : null
        }));
    }

    return {
        "asserted" : newWMEID
    };
};

/** The Assert Action Definition */
module.exports = AssertAction;
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-ReteActionAssert.html">ReteActionAssert</a></li><li><a href="module-ReteActionInterface.html">ReteActionInterface</a></li><li><a href="module-ReteActionRetract.html">ReteActionRetract</a></li><li><a href="module-ReteActions.html">ReteActions</a></li><li><a href="module-ReteActivationAndDeletion.html">ReteActivationAndDeletion</a></li><li><a href="module-ReteArithmeticActions.html">ReteArithmeticActions</a></li><li><a href="module-ReteClassInterface.html">ReteClassInterface</a></li><li><a href="module-ReteComparisonOperators.html">ReteComparisonOperators</a></li><li><a href="module-ReteDataStructures.html">ReteDataStructures</a></li><li><a href="module-ReteNetworkBuilding.html">ReteNetworkBuilding</a></li><li><a href="module-ReteTestExecution.html">ReteTestExecution</a></li><li><a href="module-ReteUtilities.html">ReteUtilities</a></li><li><a href="module-RuleCtors.html">RuleCtors</a></li></ul><h3>Classes</h3><ul><li><a href="module-ReteActionAssert-AssertAction.html">AssertAction</a></li><li><a href="module-ReteActionRetract-RetractAction.html">RetractAction</a></li><li><a href="module-ReteClassInterface-ReteNet.html">ReteNet</a></li><li><a href="module-ReteDataStructures-ActionNode.html">ActionNode</a></li><li><a href="module-ReteDataStructures-AlphaMemory.html">AlphaMemory</a></li><li><a href="module-ReteDataStructures-AlphaMemoryItem.html">AlphaMemoryItem</a></li><li><a href="module-ReteDataStructures-AlphaNode.html">AlphaNode</a></li><li><a href="module-ReteDataStructures-BetaMemory.html">BetaMemory</a></li><li><a href="module-ReteDataStructures-JoinNode.html">JoinNode</a></li><li><a href="module-ReteDataStructures-NCCNode.html">NCCNode</a></li><li><a href="module-ReteDataStructures-NCCPartnerNode.html">NCCPartnerNode</a></li><li><a href="module-ReteDataStructures-NegativeJoinResult.html">NegativeJoinResult</a></li><li><a href="module-ReteDataStructures-NegativeNode.html">NegativeNode</a></li><li><a href="module-ReteDataStructures-ProposedAction.html">ProposedAction</a></li><li><a href="module-ReteDataStructures-ReteNode.html">ReteNode</a></li><li><a href="module-ReteDataStructures-Token.html">Token</a></li><li><a href="module-ReteDataStructures-WME.html">WME</a></li><li><a href="module-RuleCtors-Action.html">Action</a></li><li><a href="module-RuleCtors-Condition.html">Condition</a></li><li><a href="module-RuleCtors-Rule.html">Rule</a></li></ul><h3>Interfaces</h3><ul><li><a href="module-ReteActionInterface-ActionInterface.html">ActionInterface</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.0</a> on Sat Feb 27 2016 22:29:38 GMT-0800 (PST)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
